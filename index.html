<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Travel Here — Formulaire</title>
  <meta name="description" content="Travel Here : Top 3 (pack vol + hôtel + activité) en affichage premium." />

  <style>
    :root{
      --text: rgba(255,255,255,.94);
      --muted: rgba(255,255,255,.74);
      --muted2: rgba(255,255,255,.58);
      --stroke: rgba(255,255,255,.20);
      --accent: #60A5FA;
      --accent2:#34D399;
      --shadow: 0 22px 64px rgba(0,0,0,.45);
      --r: 18px;
      --r2: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      background:#050711;
      overflow-x:hidden;
    }

    /* Background slideshow */
    .bg{ position:fixed; inset:0; z-index:-3; background:#050711; }
    .bg .slide{
      position:absolute; inset:0;
      background-size:cover;
      background-position:center;
      opacity:0;
      transform: scale(1.06);
      animation: slideShow 30s infinite;
      filter: saturate(1.12) contrast(1.06);
    }
    .bg .slide:nth-child(1){ background-image:url("https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=2200&q=80"); animation-delay:0s; }
    .bg .slide:nth-child(2){ background-image:url("https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=2200&q=80"); animation-delay:6s; }
    .bg .slide:nth-child(3){ background-image:url("https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?auto=format&fit=crop&w=2200&q=80"); animation-delay:12s; }
    .bg .slide:nth-child(4){ background-image:url("https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?auto=format&fit=crop&w=2200&q=80"); animation-delay:18s; }
    .bg .slide:nth-child(5){ background-image:url("https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=2200&q=80"); animation-delay:24s; }
    @keyframes slideShow{
      0%{opacity:0}
      10%{opacity:1}
      25%{opacity:1}
      35%{opacity:0}
      100%{opacity:0}
    }

    .overlay{
      position:fixed; inset:0; z-index:-2;
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(96,165,250,.22), transparent 60%),
        radial-gradient(900px 600px at 85% 30%, rgba(52,211,153,.16), transparent 60%),
        linear-gradient(180deg, rgba(3,7,18,.52), rgba(3,7,18,.40));
    }

    .noise{
      pointer-events:none;
      position:fixed; inset:0; z-index:-1;
      opacity:.08;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      mix-blend-mode:overlay;
      animation: noiseShift 10s linear infinite;
    }
    @keyframes noiseShift{
      0%{transform:translate3d(0,0,0)}
      100%{transform:translate3d(-80px,60px,0)}
    }

    /* Layout */
    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 10px;
    }
    .shell{ width: min(980px, 100%); display:grid; grid-template-columns: 1fr; }
    .panel{
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.10));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .right{ padding: 14px 12px; }

    /* Header */
    .brandRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight: 1000; letter-spacing:-.8px; font-size: 18px;
    }
    .logoDot{
      width:10px; height:10px; border-radius:50%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 0 0 7px rgba(96,165,250,.12);
      display:inline-block;
    }
    .badge{
      display:inline-flex; align-items:center; gap:10px;
      padding: 8px 12px; border-radius: 999px;
      background: rgba(96,165,250,.16);
      border: 1px solid rgba(96,165,250,.26);
      color: rgba(255,255,255,.92);
      font-size: 13px; letter-spacing:.2px;
      user-select:none; white-space:nowrap;
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background: var(--accent2);
      box-shadow: 0 0 0 4px rgba(52,211,153,.18);
      animation: pulse 1.6s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{transform:scale(1); opacity:1}
      50%{transform:scale(1.25); opacity:.72}
    }

    .topLine{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom: 8px;
    }
    .topLine h2{ margin:0; font-size: 16px; letter-spacing:-.2px; }
    .hint{ margin-top:2px; color: var(--muted2); font-size: 12.5px; }

    /* Progress */
    .progressWrap{
      margin: 10px 0 10px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
    }
    .progressTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      color: rgba(255,255,255,.76); font-size: 12px;
    }
    .bar{
      height: 8px; border-radius: 999px;
      background: rgba(255,255,255,.12);
      margin-top: 8px; overflow:hidden;
    }
    .bar > div{
      height:100%; width:33%;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(96,165,250,1), rgba(52,211,153,.95));
      transition: width .25s ease;
    }

    /* Form */
    form{ display:grid; gap: 12px; margin-top: 10px; }
    .grid2{ display:grid; gap: 12px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 680px){ .grid2{grid-template-columns:1fr;} }
    label{
      display:block; font-size: 12.5px;
      color: rgba(255,255,255,.82);
      margin-bottom: 6px;
    }
    .field{position:relative;}
    input, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.92);
      outline:none;
      transition: border-color .18s ease, background .18s ease, box-shadow .18s ease, transform .18s ease;
      backdrop-filter: blur(10px);
      font-size: 16px; /* anti-zoom iPhone */
    }
    textarea{min-height: 110px; resize: vertical}
    input::placeholder, textarea::placeholder{color: rgba(255,255,255,.52)}
    input:focus, textarea:focus{
      border-color: rgba(96,165,250,.55);
      box-shadow: 0 0 0 4px rgba(96,165,250,.18);
      background: rgba(0,0,0,.22);
      transform: translateY(-1px);
    }

    .dateInput{ padding-right: 46px; cursor:pointer; }
    .calIcon{
      position:absolute; right: 10px; top: 34px;
      width: 22px; height: 22px; opacity:.92;
      cursor:pointer; pointer-events:auto;
      filter: drop-shadow(0 6px 18px rgba(0,0,0,.25));
    }

    /* Pills */
    .pillGroup{ display:flex; flex-wrap:wrap; gap: 8px; margin-top: 8px; }
    .pill{
      cursor:pointer; user-select:none;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.90);
      font-size: 13px;
      font-weight: 900;
      transition: transform .16s ease, background .16s ease, border-color .16s ease;
      white-space:nowrap;
    }
    .pill:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.22)}
    .pill[data-on="1"]{ background: rgba(96,165,250,.18); border-color: rgba(96,165,250,.34); }
    .sr{position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden;}

    /* Chips */
    .chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;}
    .chip{
      cursor:pointer; user-select:none;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.90);
      font-size: 12.5px;
      transition: transform .16s ease, background .16s ease, border-color .16s ease;
      white-space:nowrap;
    }
    .chip:hover{transform: translateY(-1px); border-color: rgba(255,255,255,.22)}
    .chip[data-on="1"]{ background: rgba(96,165,250,.18); border-color: rgba(96,165,250,.32); }

    /* Notes counter */
    .counterRow{
      display:flex; justify-content:space-between; gap:10px;
      margin-top:6px; color: rgba(255,255,255,.62);
      font-size: 12px;
    }

    /* Autocomplete dropdown */
    .suggest{
      position:absolute;
      top: calc(100% + 8px);
      left:0; right:0;
      background: rgba(10,12,20,.90);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 14px;
      overflow:hidden;
      box-shadow: 0 18px 44px rgba(0,0,0,.45);
      display:none;
      z-index: 50;
      backdrop-filter: blur(12px);
      max-height: 320px;
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
    }
    .suggest button{
      width:100%;
      text-align:left;
      border:0;
      background: transparent;
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      cursor:pointer;
      font-size: 14px;
      transition: background .14s ease;
    }
    .suggest button:hover{ background: rgba(96,165,250,.14); }

    /* Buttons */
    .btn{
      border:0; width:100%;
      padding: 12px 14px;
      border-radius: 14px;
      font-weight: 1000; letter-spacing:.2px;
      color:white;
      background: linear-gradient(135deg, rgba(96,165,250,1), rgba(52,211,153,.95));
      box-shadow: 0 14px 38px rgba(0,0,0,.26);
      cursor:pointer;
      transition: transform .16s ease, filter .16s ease;
    }
    .btn:hover{transform: translateY(-1px); filter: brightness(1.03)}
    .btn:active{transform: translateY(0px); filter: brightness(.98)}
    .btn:disabled{ opacity:.65; cursor:not-allowed; transform:none; }
    .secondaryBtn{
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color:white;
      padding: 12px 14px;
      border-radius: 14px;
      font-weight: 900;
      cursor:pointer;
      width:100%;
    }

    /* Desktop date picker */
    .dpBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px 12px;
      z-index: 120;
    }
    .dp{
      width: min(360px, 100%);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.10));
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .dpHeader{
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.14);
    }
    .dpHeader b{ font-size: 14px; letter-spacing:-.2px; }
    .dpNav{ display:flex; gap: 8px; }
    .dpBtn{
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      width: 34px; height:34px;
      border-radius: 12px;
      cursor:pointer;
    }
    .dpGrid{ padding: 10px 12px 14px; }
    .dpWeek{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-bottom: 8px;
      color: rgba(255,255,255,.62);
      font-size: 12px;
      text-align:center;
    }
    .dpDays{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }
    .day{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      color: rgba(255,255,255,.92);
      border-radius: 12px;
      height: 40px;
      cursor:pointer;
      font-weight: 900;
      font-size: 13px;
      transition: transform .14s ease, background .14s ease, border-color .14s ease;
    }
    .day:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); background: rgba(96,165,250,.14); }
    .day.isToday{ border-color: rgba(52,211,153,.32); background: rgba(52,211,153,.10); }
    .day.isSelected{ border-color: rgba(96,165,250,.45); background: rgba(96,165,250,.22); }

    /* RESULTS (super mis en avant) */
    .resultHero{
      margin-top: 10px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(900px 380px at 10% 0%, rgba(96,165,250,.34), transparent 55%),
        radial-gradient(900px 380px at 90% 0%, rgba(52,211,153,.26), transparent 55%),
        rgba(255,255,255,.08);
      box-shadow: 0 28px 90px rgba(0,0,0,.55);
      overflow:hidden;
      transform: translateY(10px) scale(.985);
      opacity: 0;
      transition: transform .45s ease, opacity .45s ease;
    }
    .resultHero.on{
      transform: translateY(0) scale(1);
      opacity: 1;
    }
    .resultHeroHead{
      padding: 14px 14px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,.12);
    }
    .resultHeroHead h3{
      margin:0;
      font-size: 15px;
      letter-spacing:-.2px;
    }
    .resultHeroHead .sub{
      margin: 4px 0 0;
      color: rgba(255,255,255,.72);
      font-size: 12.5px;
      line-height: 1.3;
    }
    .pillMini{
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.86);
      white-space:nowrap;
    }

    .rankGrid{ padding: 12px; display:grid; gap: 10px; }
    .rankCard{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.16);
      overflow:hidden;
      animation: popIn .35s ease both;
    }
    .rankCard:nth-child(2){ animation-delay: .06s; }
    .rankCard:nth-child(3){ animation-delay: .12s; }
    @keyframes popIn{
      from{ transform: translateY(8px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }

    .rankTop{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }
    .rankTop b{
      display:flex; align-items:center; gap:10px;
      font-size: 13.5px;
      letter-spacing:-.2px;
    }
    .rankBadge{
      width: 26px; height:26px;
      border-radius: 10px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(96,165,250,.30), rgba(52,211,153,.22));
      border: 1px solid rgba(255,255,255,.18);
      font-weight: 1000;
    }
    .rankMeta{ display:flex; gap: 8px; flex-wrap:wrap; justify-content:flex-end; }
    .metaTag{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(96,165,250,.14);
      border: 1px solid rgba(96,165,250,.22);
      color: rgba(255,255,255,.84);
      white-space:nowrap;
    }

    .rankBody{ padding: 10px 12px 12px; display:grid; gap: 8px; }
    .triple{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 10px;
    }
    .tripleHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 6px;
    }
    .tripleHead .t{
      font-weight: 1000;
      font-size: 12.5px;
      letter-spacing:-.2px;
      display:flex; align-items:center; gap:8px;
    }
    .price{
      font-weight: 1000;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(52,211,153,.14);
      border: 1px solid rgba(52,211,153,.22);
      color: rgba(255,255,255,.90);
      white-space:nowrap;
    }
    .line{ font-size: 12.5px; color: rgba(255,255,255,.80); line-height: 1.35; }
    .mini{ margin-top: 2px; font-size: 12px; color: rgba(255,255,255,.62); line-height: 1.35; }

    .loadingBlock{ padding: 14px; display:grid; gap: 10px; }
    .loadingLine{
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      overflow:hidden;
      position:relative;
    }
    .loadingLine::after{
      content:"";
      position:absolute; inset:0;
      transform: translateX(-60%);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.22), transparent);
      animation: shimmer 1.2s ease-in-out infinite;
    }
    @keyframes shimmer{
      0%{ transform: translateX(-60%); }
      100%{ transform: translateX(60%); }
    }

    .errorBox{
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(251,113,133,.10);
    }
  </style>
</head>

<body>
  <div class="bg">
    <div class="slide"></div><div class="slide"></div><div class="slide"></div><div class="slide"></div><div class="slide"></div>
  </div>
  <div class="overlay"></div>
  <div class="noise"></div>

  <div class="wrap">
    <div class="shell">
      <aside class="panel right">
        <div class="brandRow">
          <div class="brand"><span class="logoDot"></span><span>Travel Here</span></div>
          <div class="badge"><span class="dot"></span><span>Premium</span></div>
        </div>

        <div class="topLine">
          <div>
            <h2>Formulaire</h2>
            <div class="hint">3 étapes • le résultat s’affiche ici à la fin</div>
          </div>
          <div class="badge" style="background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.18);">
            <span style="opacity:.92">~ 45s</span>
          </div>
        </div>

        <div class="progressWrap">
          <div class="progressTop">
            <span id="stepLabel">Étape 1/3</span>
            <span id="stepHint">Voyage</span>
          </div>
          <div class="bar"><div id="progressBar"></div></div>
        </div>

        <form id="tripForm" novalidate>
          <!-- STEP 1 -->
          <div class="step" data-step="1">
            <div class="grid2">
              <div class="field">
                <label for="origin">Ville de départ</label>
                <input id="origin" name="origin" placeholder="Tape une ville..." autocomplete="off" />
                <div class="suggest" id="originSuggest"></div>
              </div>

              <div class="field">
                <label for="destination">Destination</label>
                <input id="destination" name="destination" placeholder="Tape une ville..." autocomplete="off" required />
                <div class="suggest" id="destSuggest"></div>
              </div>
            </div>

            <div class="grid2">
              <div class="field">
                <label for="checkInDate">Date d’arrivée</label>
                <input id="checkInDate" name="checkInDate" class="dateInput" placeholder="Choisir une date" autocomplete="off" required />
                <svg class="calIcon" id="calIconIn" viewBox="0 0 24 24" fill="none" role="button" aria-label="Ouvrir calendrier arrivée">
                  <path d="M7 2v3M17 2v3M3.5 9h17" stroke="white" stroke-opacity=".9" stroke-width="1.6" stroke-linecap="round"/>
                  <path d="M6 6h12a2.5 2.5 0 0 1 2.5 2.5V19A2.5 2.5 0 0 1 18 21.5H6A2.5 2.5 0 0 1 3.5 19V8.5A2.5 2.5 0 0 1 6 6Z" stroke="white" stroke-opacity=".9" stroke-width="1.6"/>
                </svg>
              </div>

              <div class="field">
                <label for="checkOutDate">Date de départ</label>
                <input id="checkOutDate" name="checkOutDate" class="dateInput" placeholder="Choisir une date" autocomplete="off" required />
                <svg class="calIcon" id="calIconOut" viewBox="0 0 24 24" fill="none" role="button" aria-label="Ouvrir calendrier départ">
                  <path d="M7 2v3M17 2v3M3.5 9h17" stroke="white" stroke-opacity=".9" stroke-width="1.6" stroke-linecap="round"/>
                  <path d="M6 6h12a2.5 2.5 0 0 1 2.5 2.5V19A2.5 2.5 0 0 1 18 21.5H6A2.5 2.5 0 0 1 3.5 19V8.5A2.5 2.5 0 0 1 6 6Z" stroke="white" stroke-opacity=".9" stroke-width="1.6"/>
                </svg>
              </div>
            </div>
          </div>

          <!-- STEP 2 -->
          <div class="step" data-step="2" style="display:none">
            <div class="grid2">
              <div class="field">
                <label for="adults">Adultes</label>
                <input id="adults" name="adults" type="number" min="1" max="9" value="2" />
              </div>
              <div class="field">
                <label for="children">Enfants</label>
                <input id="children" name="children" type="number" min="0" max="9" value="0" />
              </div>
            </div>

            <div class="grid2">
              <div class="field">
                <label for="roomQuantity">Chambres</label>
                <input id="roomQuantity" name="roomQuantity" type="number" min="1" max="9" value="1" />
              </div>
              <div class="field">
                <label for="budget">Budget total (optionnel)</label>
                <input id="budget" name="budget" type="number" min="0" step="50" placeholder="Ex : 1200" />
              </div>
            </div>

            <div class="field">
              <label>Style</label>
              <div class="pillGroup" id="stylePills">
                <span class="pill" data-value="balanced" data-on="1">Équilibré</span>
                <span class="pill" data-value="budget">Petit budget</span>
                <span class="pill" data-value="comfort">Confort</span>
                <span class="pill" data-value="luxury">Luxe</span>
              </div>
              <input class="sr" id="style" name="style" value="balanced" />
            </div>

            <div class="field">
              <label>Centres d’intérêt (optionnel)</label>
              <div class="chips" id="chips">
                <span class="chip" data-value="culture">Culture</span>
                <span class="chip" data-value="food">Food</span>
                <span class="chip" data-value="nature">Nature</span>
                <span class="chip" data-value="festivities">Festivités</span>
                <span class="chip" data-value="romance">Romantique</span>
                <span class="chip" data-value="family">Famille</span>
                <span class="chip" data-value="adventure">Aventure</span>
                <span class="chip" data-value="beach">Plage</span>
                <span class="chip" data-value="shopping">Shopping</span>
                <span class="chip" data-value="relax">Détente</span>
              </div>
              <input class="sr" id="interests" name="interests" value="" />
            </div>
          </div>

          <!-- STEP 3 -->
          <div class="step" data-step="3" style="display:none">
            <!-- Notes (disparaît quand les résultats apparaissent) -->
            <div id="notesWrap">
              <div class="field">
                <label for="notes">Notes (optionnel)</label>
                <textarea id="notes" name="notes" maxlength="250" placeholder="Ex : hôtel proche centre, départ le matin, pas trop de marche…"></textarea>
                <div class="counterRow">
                  <span>Max 250 caractères</span>
                  <span id="notesCount">0/250</span>
                </div>
              </div>
            </div>

            <!-- Results (seul visible après génération) -->
            <div class="resultHero" id="resultHero" style="display:none;">
              <div class="resultHeroHead">
                <div>
                  <h3>Ton Top 3 personnalisé</h3>
                  <div class="sub" id="resultSub">—</div>
                </div>
                <div class="pillMini">Étape 3/3</div>
              </div>

              <div id="loadingBlock" class="loadingBlock" style="display:none;">
                <div class="loadingLine"></div>
                <div class="loadingLine" style="width:78%"></div>
                <div class="loadingLine" style="width:62%"></div>
                <div class="loadingLine" style="width:70%"></div>
              </div>

              <div class="rankGrid" id="rankGrid"></div>
            </div>
          </div>

          <div style="display:flex;gap:10px;">
            <button type="button" class="secondaryBtn" id="backBtn" style="flex:1;display:none;">Retour</button>
            <button type="button" class="btn" id="nextBtn" style="flex:2;">Continuer</button>
          </div>
        </form>
      </aside>
    </div>
  </div>

  <!-- Desktop date picker -->
  <div class="dpBackdrop" id="dpBackdrop">
    <div class="dp" role="dialog" aria-modal="true" aria-label="Choisir une date">
      <div class="dpHeader">
        <b id="dpTitle">Mois</b>
        <div class="dpNav">
          <button class="dpBtn" id="dpPrev" type="button">‹</button>
          <button class="dpBtn" id="dpNext" type="button">›</button>
        </div>
      </div>
      <div class="dpGrid">
        <div class="dpWeek">
          <div>L</div><div>M</div><div>M</div><div>J</div><div>V</div><div>S</div><div>D</div>
        </div>
        <div class="dpDays" id="dpDays"></div>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const WEBHOOK_URL = "https://fullplata.app.n8n.cloud/webhook-test/voyage-ia";
    // IMPORTANT: webhook-test = marche quand ton workflow n8n est en mode test (Execute). Pour public -> webhook (prod).

    // ===========================
    // MINI "BASE" AÉROPORTS + CONVERSION INSTANTANÉE
    // - Si l'utilisateur choisit une suggestion, on garde lat/lon dans dataset => conversion instant
    // - Sinon fallback : géocode (1 call) puis nearest airport
    // ===========================

    // Base mini mais solide (Europe + grandes villes monde)
    const AIRPORTS_DB = [
      // France
      {iata:"CDG",lat:49.0097,lon:2.5479},{iata:"ORY",lat:48.7262,lon:2.3652},{iata:"BVA",lat:49.4544,lon:2.1128},
      {iata:"LYS",lat:45.7256,lon:5.0811},{iata:"MRS",lat:43.4393,lon:5.2214},{iata:"NCE",lat:43.6653,lon:7.2150},
      {iata:"TLS",lat:43.6293,lon:1.3633},{iata:"BOD",lat:44.8283,lon:-0.7156},{iata:"NTE",lat:47.1532,lon:-1.6107},
      {iata:"LIL",lat:50.5633,lon:3.0869},{iata:"SXB",lat:48.5383,lon:7.6282},{iata:"MLH",lat:47.59,lon:7.5292},
      {iata:"MPL",lat:43.5762,lon:3.9630},{iata:"RNS",lat:48.0695,lon:-1.7348},{iata:"SVO",lat:55.9726,lon:37.4146}, // (pas France, ignore - ancien, mais ok)
      // Espagne / Portugal
      {iata:"MAD",lat:40.4722,lon:-3.5608},{iata:"BCN",lat:41.2974,lon:2.0833},{iata:"AGP",lat:36.6749,lon:-4.4991},
      {iata:"VLC",lat:39.4893,lon:-0.4816},{iata:"SVQ",lat:37.4180,lon:-5.8931},{iata:"BIO",lat:43.3011,lon:-2.9106},
      {iata:"PMI",lat:39.5517,lon:2.7388},{iata:"IBZ",lat:38.8729,lon:1.3731},{iata:"LPA",lat:27.9319,lon:-15.3866},
      {iata:"TFS",lat:28.0445,lon:-16.5725},{iata:"ALC",lat:38.2822,lon:-0.5582},
      {iata:"LIS",lat:38.7742,lon:-9.1342},{iata:"OPO",lat:41.2481,lon:-8.6814},{iata:"FAO",lat:37.0144,lon:-7.9659},
      // UK / Ireland
      {iata:"LHR",lat:51.4700,lon:-0.4543},{iata:"LGW",lat:51.1537,lon:-0.1821},{iata:"STN",lat:51.8850,lon:0.2350},
      {iata:"MAN",lat:53.3537,lon:-2.2749},{iata:"EDI",lat:55.9500,lon:-3.3725},{iata:"DUB",lat:53.4213,lon:-6.2701},
      // Italie
      {iata:"FCO",lat:41.8003,lon:12.2389},{iata:"CIA",lat:41.7994,lon:12.5949},{iata:"MXP",lat:45.6306,lon:8.7281},
      {iata:"LIN",lat:45.4451,lon:9.2767},{iata:"VCE",lat:45.5053,lon:12.3519},{iata:"NAP",lat:40.8860,lon:14.2908},
      {iata:"CTA",lat:37.4668,lon:15.0664},{iata:"BLQ",lat:44.5354,lon:11.2887},
      // Allemagne / Suisse / Autriche / Benelux
      {iata:"BER",lat:52.3667,lon:13.5033},{iata:"FRA",lat:50.0379,lon:8.5622},{iata:"MUC",lat:48.3538,lon:11.7861},
      {iata:"HAM",lat:53.6304,lon:9.9882},{iata:"DUS",lat:51.2895,lon:6.7668},
      {iata:"ZRH",lat:47.4581,lon:8.5555},{iata:"GVA",lat:46.2381,lon:6.1090},{iata:"BSL",lat:47.59,lon:7.5292},
      {iata:"VIE",lat:48.1103,lon:16.5697},
      {iata:"AMS",lat:52.3105,lon:4.7683},{iata:"BRU",lat:50.9010,lon:4.4844},{iata:"LUX",lat:49.6233,lon:6.2044},
      // Europe centrale / Nordiques / Balkans
      {iata:"PRG",lat:50.1008,lon:14.26},{iata:"WAW",lat:52.1657,lon:20.9671},{iata:"BUD",lat:47.4369,lon:19.2556},
      {iata:"CPH",lat:55.6180,lon:12.6508},{iata:"ARN",lat:59.6519,lon:17.9186},{iata:"OSL",lat:60.1939,lon:11.1004},
      {iata:"HEL",lat:60.3172,lon:24.9633},{iata:"KEF",lat:63.9850,lon:-22.6056},
      {iata:"ATH",lat:37.9364,lon:23.9445},{iata:"SKG",lat:40.5197,lon:22.9709},
      {iata:"IST",lat:41.2753,lon:28.7519},{iata:"SAW",lat:40.8986,lon:29.3092},
      {iata:"OTP",lat:44.5711,lon:26.0850},{iata:"SOF",lat:42.6967,lon:23.4114},{iata:"BEG",lat:44.8193,lon:20.3069},
      {iata:"ZAG",lat:45.7429,lon:16.0688},{iata:"DBV",lat:42.5614,lon:18.2682},
      // Monde (grandes plaques)
      {iata:"DXB",lat:25.2532,lon:55.3657},{iata:"DOH",lat:25.2731,lon:51.6081},{iata:"AUH",lat:24.4330,lon:54.6511},
      {iata:"JFK",lat:40.6413,lon:-73.7781},{iata:"EWR",lat:40.6895,lon:-74.1745},{iata:"LAX",lat:33.9416,lon:-118.4085},
      {iata:"SFO",lat:37.6213,lon:-122.3790},{iata:"MIA",lat:25.7959,lon:-80.2870},{iata:"ORD",lat:41.9742,lon:-87.9073},
      {iata:"YYZ",lat:43.6777,lon:-79.6248},{iata:"YUL",lat:45.4706,lon:-73.7408},{iata:"YVR",lat:49.1967,lon:-123.1815},
      {iata:"GRU",lat:-23.4356,lon:-46.4731},{iata:"GIG",lat:-22.8099,lon:-43.2506},
      {iata:"EZE",lat:-34.8222,lon:-58.5358},
      {iata:"CAI",lat:30.1120,lon:31.4000},{iata:"CMN",lat:33.3675,lon:-7.5898},{iata:"TUN",lat:36.8510,lon:10.2272},
      {iata:"JNB",lat:-26.1367,lon:28.2410},
      {iata:"HND",lat:35.5494,lon:139.7798},{iata:"NRT",lat:35.7720,lon:140.3929},{iata:"ICN",lat:37.4602,lon:126.4407},
      {iata:"SIN",lat:1.3644,lon:103.9915},{iata:"BKK",lat:13.6900,lon:100.7501},{iata:"HKG",lat:22.3080,lon:113.9185},
      {iata:"SYD",lat:-33.9399,lon:151.1753},{iata:"MEL",lat:-37.6733,lon:144.8430}
    ];

    function haversine(lat1, lon1, lat2, lon2){
      const R = 6371;
      const toRad = (d) => (d * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    function findNearestAirport(lat, lon){
      let best = null;
      let bestDist = Infinity;
      for(const a of AIRPORTS_DB){
        const d = haversine(lat, lon, a.lat, a.lon);
        if(d < bestDist){
          bestDist = d;
          best = a;
        }
      }
      return best;
    }

    async function geocodeCity(city){
      const q = (city || "").trim();
      if(q.length < 2) return null;
      const url = "https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=1&accept-language=fr&q=" + encodeURIComponent(q);
      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if(!res.ok) return null;
      const data = await res.json();
      if(!data || !data[0]) return null;
      return { lat: Number(data[0].lat), lon: Number(data[0].lon) };
    }

    function isIata3(s){
      return /^[A-Za-z]{3}$/.test((s||"").trim());
    }

    // ===========================
    // Fast autocomplete (priorité + cache + debounce + abort)
    // + on stocke lat/lon dans la suggestion => conversion instant
    // ===========================
    const POPULAR_CITIES = [
      // ajout lat/lon pour conversion instant (sans requête supplémentaire)
      { label: "Paris — France", value: "Paris", lat: 48.8566, lon: 2.3522 },
      { label: "Lyon — France", value: "Lyon", lat: 45.7640, lon: 4.8357 },
      { label: "Marseille — France", value: "Marseille", lat: 43.2965, lon: 5.3698 },
      { label: "Nice — France", value: "Nice", lat: 43.7102, lon: 7.2620 },
      { label: "Toulouse — France", value: "Toulouse", lat: 43.6047, lon: 1.4442 },
      { label: "Bordeaux — France", value: "Bordeaux", lat: 44.8378, lon: -0.5792 },
      { label: "Nantes — France", value: "Nantes", lat: 47.2184, lon: -1.5536 },
      { label: "Lille — France", value: "Lille", lat: 50.6292, lon: 3.0573 },
      { label: "Bruxelles — Belgique", value: "Bruxelles", lat: 50.8503, lon: 4.3517 },
      { label: "Genève — Suisse", value: "Genève", lat: 46.2044, lon: 6.1432 },
      { label: "Londres — Royaume-Uni", value: "Londres", lat: 51.5072, lon: -0.1276 },
      { label: "Barcelone — Espagne", value: "Barcelone", lat: 41.3851, lon: 2.1734 },
      { label: "Madrid — Espagne", value: "Madrid", lat: 40.4168, lon: -3.7038 },
      { label: "Lisbonne — Portugal", value: "Lisbonne", lat: 38.7223, lon: -9.1393 },
      { label: "Rome — Italie", value: "Rome", lat: 41.9028, lon: 12.4964 },
      { label: "Milan — Italie", value: "Milan", lat: 45.4642, lon: 9.1900 },
      { label: "Berlin — Allemagne", value: "Berlin", lat: 52.5200, lon: 13.4050 },
      { label: "Amsterdam — Pays-Bas", value: "Amsterdam", lat: 52.3676, lon: 4.9041 },
      { label: "Prague — République tchèque", value: "Prague", lat: 50.0755, lon: 14.4378 },
      { label: "Athènes — Grèce", value: "Athènes", lat: 37.9838, lon: 23.7275 },
      { label: "Istanbul — Turquie", value: "Istanbul", lat: 41.0082, lon: 28.9784 },
      { label: "New York — USA", value: "New York", lat: 40.7128, lon: -74.0060 },
      { label: "Montréal — Canada", value: "Montréal", lat: 45.5019, lon: -73.5674 },
      { label: "Dubai — Émirats arabes unis", value: "Dubai", lat: 25.2048, lon: 55.2708 },
      { label: "Bangkok — Thaïlande", value: "Bangkok", lat: 13.7563, lon: 100.5018 },
      { label: "Tokyo — Japon", value: "Tokyo", lat: 35.6762, lon: 139.6503 }
    ];

    const cityCache = new Map();
    function normQ(q){ return (q||"").trim().toLowerCase(); }

    function fastLocalSuggest(q){
      const n = normQ(q);
      if(n.length < 1) return [];
      const prefix = POPULAR_CITIES.filter(c => c.value.toLowerCase().startsWith(n));
      const contains = POPULAR_CITIES.filter(c => !c.value.toLowerCase().startsWith(n) && c.value.toLowerCase().includes(n));
      return [...prefix, ...contains].slice(0, 6);
    }

    async function fetchCitySuggestions(query, signal){
      const q = query.trim();
      if(q.length < 2) return [];
      const key = normQ(q);
      if(cityCache.has(key)) return cityCache.get(key);

      const url = "https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=8&accept-language=fr&q=" + encodeURIComponent(q);
      const res = await fetch(url, { headers: { "Accept": "application/json" }, signal });
      if(!res.ok) throw new Error("nominatim");
      const data = await res.json();

      const items = data.map(item => {
        const city = item.address?.city || item.address?.town || item.address?.village || item.address?.municipality || item.display_name?.split(",")[0] || "";
        const country = item.address?.country || "";
        const lat = item.lat != null ? Number(item.lat) : null;
        const lon = item.lon != null ? Number(item.lon) : null;
        return {
          label: city ? `${city} — ${country}` : item.display_name,
          value: city ? `${city}` : item.display_name,
          lat, lon
        };
      }).filter(x => x.value);

      cityCache.set(key, items);
      if(cityCache.size > 80){
        const firstKey = cityCache.keys().next().value;
        cityCache.delete(firstKey);
      }
      return items;
    }

    function esc(str){
      return String(str)
        .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function attachSuggest(inputId, suggestId){
      const input = document.getElementById(inputId);
      const box = document.getElementById(suggestId);

      let t = null;
      let controller = null;

      function hide(){ box.style.display = "none"; box.innerHTML = ""; }
      function render(items){
        if(!items || items.length === 0){ hide(); return; }
        box.innerHTML = items.map(it => `
          <button
            type="button"
            data-value="${esc(it.value)}"
            data-lat="${(it.lat ?? "")}"
            data-lon="${(it.lon ?? "")}"
          ><div>${esc(it.label)}</div></button>
        `).join("");
        box.style.display = "block";
      }

      function clearGeo(){
        delete input.dataset.lat;
        delete input.dataset.lon;
      }

      function handleInput(){
        const q = input.value || "";
        clearGeo();

        const local = fastLocalSuggest(q);
        render(local);

        if(t) clearTimeout(t);
        t = setTimeout(async () => {
          const qq = input.value || "";
          if(qq.trim().length < 2) return;

          if(controller) controller.abort();
          controller = new AbortController();

          try{
            const remote = await fetchCitySuggestions(qq, controller.signal);
            const merged = [];
            const seen = new Set();

            for(const it of fastLocalSuggest(qq)){
              const k = it.value.toLowerCase();
              if(!seen.has(k)){ seen.add(k); merged.push(it); }
            }
            for(const it of remote){
              const k = it.value.toLowerCase();
              if(!seen.has(k)){ seen.add(k); merged.push(it); }
            }
            render(merged.slice(0, 8));
          }catch(e){ /* ignore */ }
        }, 120);
      }

      input.addEventListener("input", handleInput);
      input.addEventListener("focus", () => {
        if((input.value || "").trim().length === 0) render(POPULAR_CITIES.slice(0, 8));
        else handleInput();
      });

      box.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if(!btn) return;
        input.value = btn.dataset.value;
        const lat = btn.dataset.lat;
        const lon = btn.dataset.lon;
        if(lat && lon){
          input.dataset.lat = String(lat);
          input.dataset.lon = String(lon);
        }else{
          delete input.dataset.lat;
          delete input.dataset.lon;
        }
        hide();
        input.dispatchEvent(new Event("change"));
      });

      document.addEventListener("click", (e) => {
        if(e.target === input || box.contains(e.target)) return;
        hide();
      });

      input.addEventListener("keydown", (e) => { if(e.key === "Escape") hide(); });
    }

    attachSuggest("origin", "originSuggest");
    attachSuggest("destination", "destSuggest");

    // ===========================
    // Style / interests
    // ===========================
    const stylePills = document.getElementById('stylePills');
    const styleInput = document.getElementById('style');
    stylePills.addEventListener('click', (e) => {
      const pill = e.target.closest('.pill');
      if(!pill) return;
      [...stylePills.querySelectorAll('.pill')].forEach(p => p.dataset.on = "0");
      pill.dataset.on = "1";
      styleInput.value = pill.dataset.value;
    });

    const chips = document.getElementById('chips');
    const interestsInput = document.getElementById('interests');
    chips.addEventListener('click', (e) => {
      const chip = e.target.closest('.chip');
      if(!chip) return;
      chip.dataset.on = chip.dataset.on === "1" ? "0" : "1";
      interestsInput.value = [...chips.querySelectorAll('.chip[data-on="1"]')].map(el => el.dataset.value).join(',');
    });

    // Notes counter
    const notesEl = document.getElementById('notes');
    const notesCount = document.getElementById('notesCount');
    function updateNotesCount(){ notesCount.textContent = `${(notesEl.value||"").length}/250`; }
    notesEl.addEventListener('input', updateNotesCount);
    updateNotesCount();

    // ===========================
    // Date UX (icon opens)
    // ===========================
    const dpBackdrop = document.getElementById("dpBackdrop");
    const dpTitle = document.getElementById("dpTitle");
    const dpDays = document.getElementById("dpDays");
    const dpPrev = document.getElementById("dpPrev");
    const dpNext = document.getElementById("dpNext");

    let activeDateInput = null;
    let viewDate = new Date();
    let selectedDateISO = null;

    const MONTHS_FR = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
    function pad(n){ return String(n).padStart(2,"0"); }
    function toISO(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
    function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
    function daysInMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0).getDate(); }

    function openDatePicker(inputEl){
      activeDateInput = inputEl;

      if(inputEl.value && /^\d{4}-\d{2}-\d{2}$/.test(inputEl.value)){
        const [y,m,da] = inputEl.value.split("-").map(Number);
        viewDate = new Date(y, m-1, 1);
        selectedDateISO = inputEl.value;
      } else {
        viewDate = new Date();
        selectedDateISO = null;
      }

      renderCalendar();
      dpBackdrop.style.display = "flex";
      document.body.style.overflow = "hidden";
    }
    function closeDatePicker(){
      dpBackdrop.style.display = "none";
      document.body.style.overflow = "";
      activeDateInput = null;
    }
    function renderCalendar(){
      const m = viewDate.getMonth();
      const y = viewDate.getFullYear();
      dpTitle.textContent = `${MONTHS_FR[m]} ${y}`;
      dpDays.innerHTML = "";

      const first = startOfMonth(viewDate);
      const firstDow = (first.getDay() + 6) % 7; // Monday=0
      const total = daysInMonth(viewDate);
      for(let i=0;i<firstDow;i++){
        const blank = document.createElement("div");
        blank.style.height = "40px";
        dpDays.appendChild(blank);
      }

      const todayISO = toISO(new Date());
      for(let day=1; day<=total; day++){
        const d = new Date(y, m, day);
        const iso = toISO(d);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "day";
        btn.textContent = String(day);

        if(iso === todayISO) btn.classList.add("isToday");
        if(selectedDateISO && iso === selectedDateISO) btn.classList.add("isSelected");

        btn.addEventListener("click", () => {
          selectedDateISO = iso;
          if(activeDateInput){
            activeDateInput.value = iso;
            activeDateInput.dispatchEvent(new Event("change"));
          }
          closeDatePicker();
        });
        dpDays.appendChild(btn);
      }
    }
    dpPrev.addEventListener("click", () => { viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()-1, 1); renderCalendar(); });
    dpNext.addEventListener("click", () => { viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 1); renderCalendar(); });
    dpBackdrop.addEventListener("click", (e) => { if(e.target === dpBackdrop) closeDatePicker(); });

    function isMobile(){
      return window.matchMedia("(max-width: 900px)").matches || /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    const checkIn = document.getElementById("checkInDate");
    const checkOut = document.getElementById("checkOutDate");
    const calIconIn = document.getElementById("calIconIn");
    const calIconOut = document.getElementById("calIconOut");

    function enableDateUX(){
      if(isMobile()){
        checkIn.type = "date";
        checkOut.type = "date";
        checkIn.placeholder = "";
        checkOut.placeholder = "";
        calIconIn.onclick = () => { checkIn.showPicker?.(); checkIn.focus(); checkIn.click(); };
        calIconOut.onclick = () => { checkOut.showPicker?.(); checkOut.focus(); checkOut.click(); };
        return;
      }
      checkIn.type = "text";
      checkOut.type = "text";
      checkIn.addEventListener("click", () => openDatePicker(checkIn));
      checkOut.addEventListener("click", () => openDatePicker(checkOut));
      checkIn.addEventListener("keydown", (e) => e.preventDefault());
      checkOut.addEventListener("keydown", (e) => e.preventDefault());
      calIconIn.onclick = () => openDatePicker(checkIn);
      calIconOut.onclick = () => openDatePicker(checkOut);
    }
    enableDateUX();

    // ===========================
    // Steps + Progress
    // ===========================
    let currentStep = 1;
    const steps = [...document.querySelectorAll('.step[data-step]')];
    const backBtn = document.getElementById('backBtn');
    const nextBtn = document.getElementById('nextBtn');
    const stepLabel = document.getElementById('stepLabel');
    const stepHint = document.getElementById('stepHint');
    const progressBar = document.getElementById('progressBar');
    const hints = { 1: "Voyage", 2: "Préférences", 3: "Résultat" };

    function showStep(n){
      currentStep = n;
      steps.forEach(s => s.style.display = (Number(s.dataset.step) === n) ? "block" : "none");
      backBtn.style.display = (n === 1) ? "none" : "inline-flex";
      nextBtn.textContent = (n === 3) ? "Voir mon Top 3" : "Continuer";
      stepLabel.textContent = `Étape ${n}/3`;
      stepHint.textContent = hints[n] || "";
      progressBar.style.width = (n === 1 ? "33%" : n === 2 ? "66%" : "100%");
      window.scrollTo({top: 0, behavior: "smooth"});
    }

    function isValidDates(inDate, outDate){
      try{ return new Date(outDate) > new Date(inDate); }catch(e){ return false; }
    }
    function requiredOkForStep1(){
      const dest = document.getElementById('destination')?.value?.trim();
      const inD = document.getElementById('checkInDate')?.value?.trim();
      const outD = document.getElementById('checkOutDate')?.value?.trim();
      if(!dest || !inD || !outD) return false;
      if(!isValidDates(inD, outD)) return false;
      return true;
    }

    backBtn.addEventListener('click', () => { if(currentStep > 1) showStep(currentStep - 1); });
    nextBtn.addEventListener('click', async () => {
      if(currentStep === 1){
        if(!requiredOkForStep1()){ alert("Remplis destination + dates (départ après arrivée)."); return; }
        showStep(2); return;
      }
      if(currentStep === 2){ showStep(3); return; }
      if(currentStep === 3){ await showTop3TripletsFromN8N(); }
    });

    showStep(1);

    // ===========================
    // RESULTS: Top3 packs (vol + hôtel + activité) depuis n8n
    // ===========================
    const notesWrap = document.getElementById("notesWrap");
    const resultHero = document.getElementById("resultHero");
    const resultSub = document.getElementById("resultSub");
    const loadingBlock = document.getElementById("loadingBlock");
    const rankGrid = document.getElementById("rankGrid");

    // ==> MODIF : async + conversion ville -> IATA
    async function getFormData(){
      const originEl = document.getElementById("origin");
      const destEl = document.getElementById("destination");

      const originRaw = originEl?.value?.trim() || "";
      const destRaw = destEl?.value?.trim() || "";

      async function toIataOrKeep(raw, el){
        if(!raw) return { value: "", used: "empty", geo: null, airport: null };
        if(isIata3(raw)) return { value: raw.toUpperCase(), used: "iata_direct", geo: null, airport: null };

        // 1) instant si lat/lon déjà connus (choix suggestion)
        const lat0 = el?.dataset?.lat ? Number(el.dataset.lat) : null;
        const lon0 = el?.dataset?.lon ? Number(el.dataset.lon) : null;
        if(Number.isFinite(lat0) && Number.isFinite(lon0)){
          const ap = findNearestAirport(lat0, lon0);
          return { value: ap?.iata || raw, used: ap?.iata ? "nearest_from_suggest" : "no_airport_from_suggest", geo: {lat:lat0, lon:lon0}, airport: ap || null };
        }

        // 2) fallback : géocodage (1 call)
        const geo = await geocodeCity(raw);
        if(!geo) return { value: raw, used: "geocode_failed_keep_raw", geo: null, airport: null };
        const ap = findNearestAirport(geo.lat, geo.lon);
        return { value: ap?.iata || raw, used: ap?.iata ? "nearest_from_geocode" : "no_airport_from_geocode", geo, airport: ap || null };
      }

      const originConv = await toIataOrKeep(originRaw, originEl);
      const destConv = await toIataOrKeep(destRaw, destEl);

      return {
        // ce que n8n recevra :
        origin: originConv.value,
        destination: destConv.value,

        // bonus debug (tu peux les enlever plus tard)
        origin_meta: originConv,
        destination_meta: destConv,

        checkInDate: document.getElementById("checkInDate")?.value?.trim() || "",
        checkOutDate: document.getElementById("checkOutDate")?.value?.trim() || "",
        adults: Number(document.getElementById("adults")?.value || 2),
        children: Number(document.getElementById("children")?.value || 0),
        roomQuantity: Number(document.getElementById("roomQuantity")?.value || 1),
        budget: document.getElementById("budget")?.value?.trim() || "",
        style: document.getElementById("style")?.value || "balanced",
        interests: document.getElementById("interests")?.value || "",
        notes: (document.getElementById("notes")?.value || "").trim()
      };
    }

    function renderTriplets(triplets, payload){
      const head = `${payload.destination || "—"} • ${payload.checkInDate || "—"} → ${payload.checkOutDate || "—"} • ${payload.adults || 2} adulte(s)`;
      resultSub.textContent = head;

      const safeTriplets = triplets.slice(0,3);

      rankGrid.innerHTML = safeTriplets.map((t, idx) => `
        <div class="rankCard">
          <div class="rankTop">
            <b><span class="rankBadge">${idx+1}</span> ${esc(t.label || "Option")}</b>
            <div class="rankMeta">
              ${Array.isArray(t.meta) ? t.meta.slice(0,3).map(x => `<span class="metaTag">${esc(x)}</span>`).join("") : ""}
            </div>
          </div>
          <div class="rankBody">
            <div class="triple">
              <div class="tripleHead">
                <div class="t">✈️ Vol</div>
                <div class="price">${esc(t.flight?.price || "—")}</div>
              </div>
              <div class="line"><b>${esc(t.flight?.title || "—")}</b></div>
              <div class="mini">${esc(t.flight?.line || "—")}</div>
            </div>

            <div class="triple">
              <div class="tripleHead">
                <div class="t">🏨 Hôtel</div>
                <div class="price">${esc(t.hotel?.price || "—")}</div>
              </div>
              <div class="line"><b>${esc(t.hotel?.title || "—")}</b></div>
              <div class="mini">${esc(t.hotel?.line || "—")}</div>
            </div>

            <div class="triple">
              <div class="tripleHead">
                <div class="t">🎟️ Activité</div>
                <div class="price">${esc(t.activity?.price || "—")}</div>
              </div>
              <div class="line"><b>${esc(t.activity?.title || "—")}</b></div>
              <div class="mini">${esc(t.activity?.line || "—")}</div>
            </div>
          </div>
        </div>
      `).join("");
    }

    async function showTop3TripletsFromN8N(){
      // ==> MODIF : await getFormData() (car conversion IATA peut être async)
      const payload = await getFormData();

      // UI: results only
      notesWrap.style.display = "none";
      resultHero.style.display = "block";
      requestAnimationFrame(() => resultHero.classList.add("on"));

      loadingBlock.style.display = "grid";
      rankGrid.innerHTML = "";

      nextBtn.disabled = true;
      nextBtn.textContent = "Génération…";

      try{
        const res = await fetch(WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if(!res.ok) throw new Error("Webhook HTTP " + res.status);

        const data = await res.json();
        const triplets = Array.isArray(data.top3) ? data.top3 : [];

        loadingBlock.style.display = "none";

        if(triplets.length === 0){
          rankGrid.innerHTML = `
            <div class="errorBox">
              <div style="font-weight:1000;">Aucun Top 3 reçu</div>
              <div class="mini" style="margin-top:6px;">
                Ton webhook a répondu, mais il n’a pas renvoyé <b>top3</b>.
              </div>
              <div class="mini" style="margin-top:8px;opacity:.85;">
                Codes envoyés : <b>${esc(payload.origin || "—")}</b> → <b>${esc(payload.destination || "—")}</b>
              </div>
            </div>
          `;
        } else {
          renderTriplets(triplets, payload);
          // auto scroll to results
          resultHero.scrollIntoView({ behavior: "smooth", block: "start" });
        }

      } catch (e){
        loadingBlock.style.display = "none";
        rankGrid.innerHTML = `
          <div class="errorBox">
            <div style="font-weight:1000;">Erreur d’appel n8n</div>
            <div class="mini" style="margin-top:6px;">
              Souvent c’est <b>CORS</b> ou le webhook-test inactif.
            </div>
            <div class="mini" style="opacity:.85;margin-top:6px;">${esc(e.message || String(e))}</div>
          </div>
        `;
      } finally {
        nextBtn.disabled = false;
        nextBtn.textContent = "Régénérer";
      }
    }
  </script>
</body>
</html>
